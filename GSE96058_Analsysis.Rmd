---
title: "GSE96058 Breast Cancer RNA-seq Dataset"
author: "Daniel Incicau"
date: "2025-07-18"
output: 
  html_document: defaults
params:
  seed: 69
---

## Setup and Package Installation

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=12, warning=FALSE, message=FALSE, dev='png', dpi=300)

SEED = params$seed
set.seed(SEED)

options(repos = c(CRAN = "https://cran.rstudio.com/"))
required_packages <- c(
  "tidyverse", "data.table", "readr", "umap", "Rtsne", "GEOquery", "ggplot2", "pheatmap", "patchwork"
)

new_packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

# Load Bioconductor packages
if (!require("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}

bioc_packages <- c("limma", "edgeR")
BiocManager::install(bioc_packages[!bioc_packages %in% installed.packages()[,"Package"]])

# Load all packages
lapply(c(required_packages, bioc_packages), library, character.only = TRUE)
```

## Phase 1: Data Download & Preprocessing

### 1.1 Download Data from GEO

```{r}
gse <- getGEO("GSE96058", GSEMatrix = TRUE, AnnotGPL = TRUE)

# Load expression data
expression_file <- "GSE96058/GSE96058_gene_expression_3273_samples_and_136_replicates_transformed.csv.gz"
expression_data <- fread(expression_file, header = TRUE, check.names = FALSE)

# Expression Matrix
genes <- expression_data$V1
expression_matrix <- as.matrix(expression_data[, -1])
rownames(expression_matrix) <- genes

# Remove technical replicates (keep primary samples) 
primary_samples <- colnames(expression_matrix)[!grepl("repl", colnames(expression_matrix))]
expression_matrix <- expression_matrix[, primary_samples]

# Clinical Data
clinical_data <- pData(gse[[1]])
rownames(clinical_data) <- clinical_data[[1]]

# Remove not matching expression and clinical data
common_samples <- intersect(colnames(expression_matrix), rownames(clinical_df))
expression_matrix <- expression_matrix[, common_samples]
clinical_df <- clinical_df[common_samples, ]

# The resulting data was was post-processed by collapsing on 30,865 unique gene symbols (sum of FPKM values of each matching transcript), adding to each expression measurement 0.1 FPKM, and performing a log2 transformation.

cat("Dataset dimensions:", dim(expression_matrix), "\n")
cat("Number of genes:", nrow(expression_matrix), "\n")
cat("Number of samples:", ncol(expression_matrix), "\n")
cat("Clinical variables:", ncol(clinical_data), "\n")
cat("Expression range:", 
    round(min(expression_matrix, na.rm = TRUE), 2), "to", 
    round(max(expression_matrix, na.rm = TRUE), 2), "\n")
```

### 1.2 Quality Control Visualizations

```{r fig.width=12, fig.height=12}
set.seed(SEED)

# QC metrics calculation
qc_df <- data.frame(
  sample_id = colnames(expression_matrix),
  total_expression = colSums(expression_matrix),
  detected_genes = colSums(expression_matrix > 0),
  mean_expression = colMeans(expression_matrix),
  stringsAsFactors = FALSE
)

# Total expression per sample
p_total_expr <- ggplot(qc_df, aes(x = total_expression)) +
  geom_histogram(bins = 50, fill = "#3498db", alpha = 0.8) +
  geom_vline(xintercept = median(qc_df$total_expression), color = "red", linetype = "dashed") +
  labs(title = "Total Expression per Sample", x = "Sum of log2(FPKM + 0.1)", y = "Sample Count") +
  theme_minimal()

# Detected genes per sample
p_detected_genes <- ggplot(qc_df, aes(x = detected_genes)) +
  geom_histogram(bins = 50, fill = "#2ecc71", alpha = 0.8) +
  geom_vline(xintercept = median(qc_df$detected_genes), color = "red", linetype = "dashed") +
  labs(title = "Detected Genes per Sample", x = "# Genes with Expression > 0", y = "Sample Count") +
  theme_minimal()

# Sample-sample correlation matrix heatmap (subset)
sample_subset <- sample(colnames(expression_matrix), min(50, ncol(expression_matrix)))
cor_matrix <- cor(expression_matrix[, sample_subset])

pheatmap(cor_matrix,
         main = "Sample Correlation Matrix (Subset of 50)",
         show_rownames = FALSE, show_colnames = FALSE,
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         clustering_method = "ward.D2",
         color = colorRampPalette(c("blue", "white", "red"))(100))

# Combine two QC histograms
p_total_expr + p_detected_genes
```

```{r fig.width=20, fig.height=12}
set.seed(SEED)

# Boxplot of expression distributions per sample (subset)
expr_subset <- expression_matrix[, sample(1:ncol(expression_matrix), min(10, ncol(expression_matrix)))]
expr_subset_df <- reshape2::melt(expr_subset)
colnames(expr_subset_df) <- c("Gene", "Sample", "Expression")

# Violin plot of expression per sample
p_violin <- ggplot(expr_subset_df, aes(x = Sample, y = Expression)) +
  geom_violin(fill = "lightblue", alpha = 0.7) +
  labs(title = "Expression Distribution (Violin Plot)", y = "log2(FPKM + 0.1)") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

p_violin
```


## Stage 2: Data Exploration & Visualisation

### 2.1 Dimensionality Reduction and Visualization

```{r}
set.seed(SEED)

# PCA
pca_result <- prcomp(t(expression_matrix), center = TRUE, scale. = TRUE)
pc_scores <- data.frame(pca_result$x[, 1:3], sample_id = rownames(pca_result$x))
pc_scores <- left_join(pc_scores, clinical_df, by = "sample_id")

# Variance explained
var_explained <- (pca_result$sdev^2 / sum(pca_result$sdev^2)) * 100

# PCA plot
p_pca <- ggplot(pc_scores, aes(x = PC1, y = PC2)) +
    geom_point(alpha = 0.7, size = 2) +
    labs(title = "PCA of Gene Expression Data",
         x = paste0("PC1 (", round(var_explained[1], 2), "%)"),
         y = paste0("PC2 (", round(var_explained[2], 2), "%)")) +
    theme_minimal()

# Scree plot (top 20 PCs)
scree_data <- data.frame(
  PC = paste0("PC", 1:20),
  Variance = var_explained[1:20]
)

p_scree <- ggplot(scree_data, aes(x = reorder(PC, -Variance), y = Variance)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(Variance, 1)), vjust = -0.5, size = 3) +
  labs(title = "Scree Plot", x = "Principal Component", y = "Variance Explained (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# t-SNE
tsne_result <- Rtsne(t(expression_matrix), dims = 2, perplexity = 30, verbose = FALSE)
tsne_df <- data.frame(tsne_result$Y)
colnames(tsne_df) <- c("tSNE1", "tSNE2")
tsne_df$sample_id <- colnames(expression_matrix)
tsne_df <- left_join(tsne_df, clinical_df, by = "sample_id")

p_tsne <- ggplot(tsne_df, aes(x = tSNE1, y = tSNE2, color = .data[[color_var]])) +
  geom_point(alpha = 0.7, size = 2) +
  labs(title = "t-SNE of Gene Expression Data", color = color_var) +
  theme_minimal()

# UMAP
umap_result <- umap(t(expression_matrix))
umap_df <- data.frame(UMAP1 = umap_result$layout[,1],
                      UMAP2 = umap_result$layout[,2],
                      sample_id = colnames(expression_matrix))
umap_df <- left_join(umap_df, clinical_df, by = "sample_id")

p_umap <- ggplot(umap_df, aes(x = UMAP1, y = UMAP2, color = .data[[color_var]])) +
  geom_point(alpha = 0.7, size = 2) +
  labs(title = "UMAP of Gene Expression Data", color = color_var) +
  theme_minimal()

p_pca
p_scree
p_tsne
p_umap
```

## Stage 3: Analysis

---

## Session Information

```{r session_info}
sessionInfo()
```